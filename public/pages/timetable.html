<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTable - JFES25</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="../index.html">JFES25</a></h1>
            <nav>
                <ul>
                    <li><a href="../index.html">Top</a></li>
                    <li><a href="theme.html">Theme&Logo</a></li>
                    <li><a href="event.html">Event</a></li>
                    <li><a href="news.html">News</a></li>
                    <li><a href="timetable.html">TimeTable</a></li>
                    <li><a href="map.html">Map</a></li>
                    <li><a href="../index.html#access">Access</a></li>
                </ul>
            </nav>
            <button class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <main>
        <section id="timetable" class="container">
            <h2>TimeTable</h2>
            <div id="timetable-display-container">
                <!-- タイムテーブルはJSでここに生成されます -->
            </div>
        </section>
    </main>

    <footer>
        <div id="access" class="container">
             <h2>Access</h2>
             <div class="access-links">
                <a href="https://www.instagram.com/your_school_insta" target="_blank">学校Instagram</a>
                <a href="https://www.instagram.com/student_council_insta" target="_blank">生徒会Instagram</a>
                <a href="https://www.youtube.com/yourschoolchannel" target="_blank">学校公式YouTube</a>
                <a href="https://www.your-school.ed.jp" target="_blank">学校公式サイト</a>
             </div>
        </div>
        <div class="container">
            <p>&copy; 2025 JFES25実行委員会</p>
        </div>
    </footer>

    <script src="../config.js"></script>
    <script src="https://unpkg.com/microcms-js-sdk@latest/dist/microcms-sdk.min.js"></script>
    <script src="../js/script.js"></script>
</body>
</html>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    if (typeof microcms === 'undefined' || !window.config || !window.config.serviceDomain || !window.config.apiKey) {
        console.error('microCMS SDK or config is not loaded.');
        document.getElementById('timetable-display-container').innerHTML = '<p>設定が読み込めませんでした。</p>';
        return;
    }

    const client = microcms.createClient({
        serviceDomain: window.config.serviceDomain,
        apiKey: window.config.apiKey,
    });

    try {
        const data = await client.get({ endpoint: 'timetable' });
        if (data.contents && data.contents.length > 0) {
            const timetableData = data.contents[0];
            renderTimetable(timetableData);
        } else {
            document.getElementById('timetable-display-container').innerHTML = '<p>タイムテーブルのデータがありません。</p>';
        }
    } catch (error) {
        console.error('Error fetching timetable data:', error);
        document.getElementById('timetable-display-container').innerHTML = '<p>タイムテーブルの読み込み中にエラーが発生しました。</p>';
    }
});

function renderTimetable(data) {
    const container = document.getElementById('timetable-display-container');
    container.innerHTML = ''; // Clear previous content

    const days = ['day1', 'day2'];
    const dayLabels = { day1: data.day1_label || '1日目', day2: data.day2_label || '2日目' };

    // Create day buttons
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'timetable-controls';
    days.forEach((day, index) => {
        const button = document.createElement('button');
        button.textContent = dayLabels[day];
        button.className = `timetable-day-btn ${index === 0 ? 'active' : ''}`;
        button.dataset.day = day;
        buttonsContainer.appendChild(button);
    });
    container.appendChild(buttonsContainer);

    days.forEach((day, index) => {
        const dayData = data[day];
        if (!dayData || dayData.length === 0) return;

        const timetableWrapper = document.createElement('div');
        timetableWrapper.id = `timetable-${day}`;
        timetableWrapper.className = `timetable-wrapper ${index === 0 ? 'active' : ''}`;
        
        const locations = [...new Set(dayData.map(item => item.location))];
        const { timeSlots, minTime, maxTime } = generateTimeSlots(dayData);
        if (!minTime) return; // Skip if no valid times
        const totalDurationMinutes = (maxTime - minTime) / (1000 * 60);
        
        // Header
        const header = document.createElement('div');
        header.className = 'timetable-header';
        header.innerHTML = `<div>時間</div>`;
        locations.forEach(loc => {
            header.innerHTML += `<div>${loc}</div>`;
        });
        timetableWrapper.appendChild(header);

        // Body
        const body = document.createElement('div');
        body.className = 'timetable-body';
        body.style.height = `${(totalDurationMinutes / 30) * 60}px`; // 60px per 30min

        // Time Axis
        const timeAxis = document.createElement('div');
        timeAxis.className = 'time-axis';
        timeSlots.forEach(slot => {
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-label';
            timeLabel.textContent = slot;
            timeAxis.appendChild(timeLabel);
        });
        body.appendChild(timeAxis);

        // Location Columns
        locations.forEach(loc => {
            const locCol = document.createElement('div');
            locCol.className = 'location-column';
            
            // Add grid lines for visual separation
            timeSlots.forEach(() => {
                const gridLine = document.createElement('div');
                gridLine.className = 'time-slot-line';
                locCol.appendChild(gridLine);
            });

            const eventsInLoc = dayData.filter(e => e.location === loc);
            eventsInLoc.forEach(event => {
                const eventDiv = createEventElement(event, minTime);
                if(eventDiv) locCol.appendChild(eventDiv);
            });
            body.appendChild(locCol);
        });
        
        timetableWrapper.appendChild(body);
        container.appendChild(timetableWrapper);
    });

    // Button functionality
    document.querySelectorAll('.timetable-day-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.timetable-day-btn, .timetable-wrapper').forEach(el => el.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(`timetable-${button.dataset.day}`).classList.add('active');
        });
    });
}

function generateTimeSlots(events) {
    const allTimes = new Set();
    events.forEach(event => {
        if(event.start_time) allTimes.add(event.start_time);
        if(event.end_time) allTimes.add(event.end_time);
    });

    const sortedTimes = [...allTimes].sort();
    if (sortedTimes.length < 2) return { timeSlots: [], minTime: null, maxTime: null };

    const minTime = new Date(`1970-01-01T${sortedTimes[0]}`);
    const maxTime = new Date(`1970-01-01T${sortedTimes[sortedTimes.length - 1]}`);
    
    const slots = [];
    let current = new Date(minTime);

    // Use 30 minute intervals
    while (current < maxTime) {
        slots.push(current.toTimeString().substring(0, 5));
        current.setMinutes(current.getMinutes() + 30);
    }
    return { timeSlots: slots, minTime, maxTime };
}

function createEventElement(event, minTime) {
    if (!event.start_time || !event.end_time) return null;

    const start = new Date(`1970-01-01T${event.start_time}`);
    const end = new Date(`1970-01-01T${event.end_time}`);
    
    const durationMinutes = (end - start) / (1000 * 60);
    if (durationMinutes <= 0) return null;

    const topOffsetMinutes = (start - minTime) / (1000 * 60);

    const height = (durationMinutes / 30) * 60; // 60px per 30min slot
    const top = (topOffsetMinutes / 30) * 60;

    const eventDiv = document.createElement('div');
    eventDiv.className = 'timetable-event';
    eventDiv.style.top = `${top}px`;
    eventDiv.style.height = `${height - 2}px`; // -2 for border
    
    eventDiv.innerHTML = `<strong>${event.title}</strong><span>${event.start_time} - ${event.end_time}</span>`;
    
    return eventDiv;
}

</script>
</html>